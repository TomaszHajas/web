<!DOCTYPE html>

<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<head>
	<style type="text/css">
		@font-face {
		  font-family: 'MyUnderwood';
		  src: url('MyUnderwood.ttf')  format('truetype');
		  font-weight: normal;
		  font-style: normal;
		}
		body {
    		  font-family: 'MyUnderwood';
		  text-align: center;
		  margin-left: auto;
                  margin-right: auto;
                  width: 40em;
		}
		input {
		  font-family: 'MyUnderwood';
		}
		button {
		  font-family: 'MyUnderwood';
		}
	</style>
	<title>The Randomizer</title>
</head>
<body background="paper_background.jpg">
	<p>Adventurers encounter...</p>
	<p id="random"></p>
	<br>
	<br>
	<button onClick="randomize()" autofocus>Roll again!</button>
	<br>
	<br>
	<form action="testTemplate.php" method="post">
		Test Template:
		<br>
		<input type="text" name="template" autocomplete="off" required><br>
		<input type="submit">
	</form>
	<br>
	<button onClick="javascript:window.location.href='/randomizer/templates.txt'">View Templates</button>
	
<script>

	// Check for the various File API support.
	if (window.File && window.FileReader && window.FileList && window.Blob) {
  		// Great success! All the File APIs are supported.
	} else {
  		alert('The File APIs are not fully supported in this browser.');
	}
	
	function getQueryVariable(variable){
       		var query = window.location.search.substring(1);
       		var vars = query.split("&");
       		for (var i=0;i<vars.length;i++) {
               		var pair = vars[i].split("=");
               		if(pair[0] == variable){return pair[1];}
       		}
       		return(false);
	}
	
	var template = getQueryVariable("template");
	var seed = getQueryVariable("seed");
	if((template == false) && (seed == 0 || seed === "")){
		var address = '/randomizer/index.html'+"?seed="+parseInt(1000000+Math.random()*9000000);
		javascript:window.location.href=address;
	}
	
	function getRandomNumber(){
		seed = (seed * 9301 + 49297) % 233280;
		return seed / 233280;
	}
	
	function randomize(){
		var address = '/randomizer/index.html'+"?seed="+parseInt(1000000+getRandomNumber()*9000000);
		javascript:window.location.href=address;
	}
	
	function rollXYTimes(howMany, maxDieRoll){
		var sum = 0;
		for(var i = 0; i < howMany; i++){
			sum += parseInt(getRandomNumber()*maxDieRoll)+1;
		}
		return sum;
	}
	
	function parseOperation(operation, number1, number2){
		switch(operation){
			case "+": return number1+number2;
			case "-": return number1-number2;
			case "*": return number1*number2;
			case ":": return parseInt(number1/number2);
			default: return 0;
		}
	}
	
	function parseRoll(match){
		var regexp = /^\d+d\d+(\-|\+|\*|\:|)?\d*$/g;
		if(regexp.test(match)){
			var numbers = match.match(/\d+/g).map(Number);
			var operation = match.replace(/\d|d/g, '');
			if(operation == null || operation == ""){
				return parseOperation("+", rollXYTimes(numbers[0], numbers[1]), 0)
			}else{
				return parseOperation(operation, rollXYTimes(numbers[0], numbers[1]), numbers[2]);
			}
		}else{
			return 0;
		}
	}
	
	function getRandomLine(text){
    		var lines = text.split('\n');
    		return lines[Math.floor(getRandomNumber()*lines.length)].replace(/\r?\n|\r/g, '');
	}
	
	function random(template){
		if(template == ''){
			document.getElementById("random").innerHTML = "ROLL TWICE AND MERGE RESULTS";
		}else if(template.includes("[") || template.includes("]")){
			regexp = /\[.*?\]/;
			firstMatch = regexp.exec(template)[0];
			firstMatchNoBrackets = firstMatch.replace(/[\[\]']+/g,'');
			if(firstMatchNoBrackets.includes("|")){
				console.log("Altenative detected");
				var array = firstMatchNoBrackets.split('|');
				replacedFirstMatch = template.replace(firstMatch, "<b>"+array[Math.floor(getRandomNumber()*array.length)]+"</b>");
				random(replacedFirstMatch);
			}else{
				if(/\d/.test(firstMatchNoBrackets)){
					console.log("Die roll detected");
					replacedFirstMatch = template.replace(firstMatch, "<b>"+parseRoll(firstMatchNoBrackets)+"</b>");
					random(replacedFirstMatch);
				}else{
					console.log("Table roll detected");
					firstMatchPath = firstMatchNoBrackets+".txt";
					fetch(firstMatchPath)
						.then(response => response.text())
						.then(text => {
						if(text.includes("DOCTYPE")){
							firstMatchPath = firstMatchNoBrackets+"/"+firstMatchNoBrackets+".txt";
							fetch(firstMatchPath)
								.then(response => response.text())
								.then(text => {
								replacedFirstMatch = template.replace(firstMatch, "<b>"+getRandomLine(text)+"</b>");
								random(replacedFirstMatch);
							})
						}else{
							replacedFirstMatch = template.replace(firstMatch, "<b>"+getRandomLine(text)+"</b>");
							random(replacedFirstMatch);
						}
					})
				}
			}
		}else{
			document.getElementById("random").innerHTML = template;
		}

	}
	
	if(template != false){
		random(template);
	}else{
		fetch("templates.txt")
			.then(response => response.text())
			.then(text => {
			randomTemplate = getRandomLine(text);
			random(randomTemplate);
		});
	}
	
</script>

</body>
