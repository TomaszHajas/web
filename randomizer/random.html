<!DOCTYPE html>

<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<head><title>Randomizer</title></head>

<body>
	<p id="random"></p>
	
<script>
	
	// Check for the various File API support.
	if (window.File && window.FileReader && window.FileList && window.Blob) {
  		// Great success! All the File APIs are supported.
	} else {
  		alert('The File APIs are not fully supported in this browser.');
	}
	
	function parseRoll(match){
		regexpDiceNumber = /[^d]*/;
		var diceNumber = regexpDiceNumber.exec(match)[0];
		console.log("diceNumber "+diceNumber);
		var matchWithoutDiceNumber = match.replace(diceNumber, '')
		console.log("matchWithoutDiceNumber "+matchWithoutDiceNumber);
		regexpDiceMaxValue = /#v([^d]+)/;
		var diceMaxValue = regexpDiceMaxValue.exec(matchWithoutDiceNumber)[0];
		var matchWithoutDiceMaxValue = match.replace(diceMaxValue, '')
		
		console.log("diceMaxValue "+diceMaxValue);
		console.log("matchWithoutDiceMaxValue "+matchWithoutDiceMaxValue);
    		return diceNumber;
	}
	
	function getRandomLine(text){
    		var lines = text.split('\n');
    		return lines[Math.floor(Math.random()*lines.length)];
	}
	
	function random(template){
		if(template == ''){
			document.getElementById("random").innerHTML = ">>> Roll twice and merge results! <<<";
		}else if(template.includes("[") || template.includes("]")){
			regexp = /\[.*?\]/;
			firstMatch = regexp.exec(template)[0];
			firstMatchNoBrackets = firstMatch.replace(/[\[\]']+/g,'');
			if(/\d/.test(firstMatchNoBrackets)){
			   	replacedFirstMatch = template.replace(firstMatch, parseRoll(firstMatchNoBrackets));
				random(replacedFirstMatch);
			}else{
				firstMatchPath = firstMatchNoBrackets+".txt";
				fetch(firstMatchPath)
  					.then(response => response.text())
  					.then(text => {
					replacedFirstMatch = template.replace(firstMatch, getRandomLine(text));
					random(replacedFirstMatch);
				});
			}
		}else{
			document.getElementById("random").innerHTML = template;
		}

	}
	
	fetch("templates.txt")
  		.then(response => response.text())
  		.then(text => {
		randomTemplate = getRandomLine(text);
		random(randomTemplate);
	});
	
</script>

</body>
