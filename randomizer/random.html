<!DOCTYPE html>

<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<head>
	<style type="text/css">
		@font-face {
		  font-family: 'MyUnderwood';
		  src: url('MyUnderwood.ttf')  format('truetype');
		  font-weight: normal;
		  font-style: normal;
		}
		body {
    		  font-family: 'MyUnderwood';
		}
	</style>
	<title>Randomizer</title>
</head>
<body>
	<p id="random"></p>
	<br>
	<button onClick="javascript:window.location.href='/randomizer/templates.txt'">View Templates</button>
	<br>
	<br>
	<form action="addTemplate.php" method="post">
		New Template:
		<br>
		<input type="text" name="template"><br>
		<input type="submit">
	</form>
	
<script>
	
	// Check for the various File API support.
	if (window.File && window.FileReader && window.FileList && window.Blob) {
  		// Great success! All the File APIs are supported.
	} else {
  		alert('The File APIs are not fully supported in this browser.');
	}
	
	function rollXYTimes(howMany, maxDieRoll){
		var sum = 0;
		for(var i = 0; i < howMany; i++){
			sum += parseInt(Math.random()*maxDieRoll)+1;
		}
		return sum;
	}
	
	function parseOperation(operation, number1, number2){
		switch(operation){
			case "+": return number1+number2;
			case "-": return number1-number2;
			case "*": return number1*number2;
			case ":": return parseInt(number1/number2);
			default: return 0;
		}
	}
	
	function parseRoll(match){
		var regexp = /^\d+d\d+(\-|\+|\*|\:|)?\d*$/g;
		if(regexp.test(match)){
			var numbers = match.match(/\d+/g).map(Number);
			var operation = match.replace(/\d|d/g, '');
			if(operation == null){
				return rollXYTimes(numbers[0], numbers[1]);
			}else{
				return parseOperation(operation, rollXYTimes(numbers[0], numbers[1]), numbers[2]);
			}
		}else{
			return 0;
		}
	}
	
	function getRandomLine(text){
    		var lines = text.split('\n');
    		return lines[Math.floor(Math.random()*lines.length)];
	}
	
	function random(template){
		if(template == ''){
			document.getElementById("random").innerHTML = ">>> Roll twice and merge results! <<<";
		}else if(template.includes("[") || template.includes("]")){
			regexp = /\[.*?\]/;
			firstMatch = regexp.exec(template)[0];
			firstMatchNoBrackets = firstMatch.replace(/[\[\]']+/g,'');
			if(/\d/.test(firstMatchNoBrackets)){
			   	replacedFirstMatch = template.replace(firstMatch, parseRoll(firstMatchNoBrackets));
				console.log(parseRoll(firstMatchNoBrackets));
				random(replacedFirstMatch);
			}else{
				firstMatchPath = firstMatchNoBrackets+".txt";
				fetch(firstMatchPath)
  					.then(response => response.text())
  					.then(text => {
					replacedFirstMatch = template.replace(firstMatch, getRandomLine(text));
					random(replacedFirstMatch);
				});
			}
		}else{
			document.getElementById("random").innerHTML = template;
		}

	}
	
	fetch("templates.txt")
  		.then(response => response.text())
  		.then(text => {
		randomTemplate = getRandomLine(text);
		random(randomTemplate);
	});
	
</script>

</body>
